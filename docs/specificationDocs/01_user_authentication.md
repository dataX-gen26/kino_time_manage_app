# 機能仕様書: ユーザー認証

- **ID**: 01
- **機能名**: Googleアカウントでのログイン
- **関連要件**: ユーザー認証

## 1. 機能概要

GoogleのOAuth 2.0を利用してユーザー認証を行う。SPAにおけるセキュリティのベストプラクティスである **PKCE (Proof Key for Code Exchange) 付き認可コードフロー** を採用する。

## 2. 仕様詳細

### 2.1. 認証フロー

1.  **認証開始 (フロントエンド)**: ユーザーが「Googleでログイン」ボタンをクリックする。
2.  **PKCEパラメータ生成 (フロントエンド)**: フロントエンドは、推測困難な文字列である `code_verifier` と、それをSHA256でハッシュ化した `code_challenge` を生成する。
3.  **Googleへリダイレクト (フロントエンド)**: `code_challenge` をパラメータに含めて、ユーザーをGoogleの認証ページにリダイレクトさせる。
4.  **認証と認可コード発行 (Google)**: ユーザーがGoogleアカウントで認証を完了すると、GoogleはフロントエンドのコールバックURLに **認可コード (`authorization_code`)** を付けてリダイレクトする。
5.  **認可コードをバックエンドへ送信 (フロントエンド)**: フロントエンドは、URLから認可コードを取得し、`code_verifier` と共にバックエンドへPOSTリクエストで送信する。
6.  **トークン交換とユーザー検証 (バックエンド)**: バックエンドは受け取った認可コードと `code_verifier` をGoogleのトークンエンドポイントに送信する。Googleはこれを検証し、問題なければ **アクセストークン** をバックエンドに発行する。
7.  **ログイン処理 (バックエンド)**: バックエンドはアクセストークンを使ってユーザー情報を取得し、DBへの保存/更新とセッション作成を行う。
8.  **ログイン完了 (フロントエンド)**: バックエンドからの成功応答を受け、フロントエンドはログイン状態となりメイン画面に遷移する。

### 2.2. ログアウトフロー

1.  ユーザーが「ログアウト」ボタンをクリックする。
2.  バックエンドはサーバー側のセッションを破棄する。
3.  フロントエンドは自身のログイン状態をクリアし、トップページに遷移する。

## 3. APIエンドポイント

- `POST /api/v1/auth/google/callback`: フロントエンドから認可コードとcode_verifierを受け取り、ログイン処理を行う。
- `DELETE /api/v1/auth/logout`: ログアウト処理を行う。
- `GET /api/v1/sessions/check`: 現在のログイン状態を確認するエンドポイント。

## 4. その他

- このフローにより、バックエンドが `client_secret` を安全に保持しつつ、フロントエンドはセキュアに認証を開始できる。