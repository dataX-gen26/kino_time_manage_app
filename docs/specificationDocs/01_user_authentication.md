# 機能仕様書: ユーザー認証

- **ID**: 01
- **機能名**: Googleアカウントでのログインと永続化
- **関連要件**: ユーザー認証

## 1. 機能概要

GoogleのOAuth 2.0を利用してユーザー認証を行う。また、ユーザーの選択に応じて「記憶トークン」方式による永続ログイン機能を提供する。

## 2. 仕様詳細

### 2.1. 通常ログインフロー（永続化なし）

1.  ユーザーがトップページの「Googleでログイン」ボタンをクリックする。
2.  バックエンドはGoogle認証を開始し、ユーザーはGoogleアカウントで認証を行う。
3.  認証成功後、バックエンドはユーザー情報をDBに保存/更新し、セッションを作成してユーザーをログイン状態にする。
4.  フロントエンドはメイン画面に遷移する。この場合、ログイン状態はブラウザを閉じると失われる。

### 2.2. 永続ログインフロー（記憶トークン方式）

1.  ユーザーが「ログイン状態を維持する」チェックボックスをオンにして、「Googleでログイン」ボタンをクリックする。
2.  上記2.1のフローに加え、バックエンドは以下の処理を行う。
    a. **記憶トークン**（ランダムで推測困難な文字列）を新規に生成する。
    b. 生成した記憶トークンを**ハッシュ化**し、対象ユーザーの`users`テーブルの`remember_digest`カラムに保存する。
    c. ハッシュ化する**前**の記憶トークンを、ユーザーのブラウザの**永続HttpOnlyクッキー**に保存する。クッキーには十分な有効期限（例: 2週間）を設定する。

### 2.3. 自動ログインフロー（永続クッキー利用）

1.  ログインしていない状態のユーザーがアプリケーションにアクセスする。
2.  バックエンドは、リクエストに永続ログイン用のクッキーが存在するか確認する。
3.  クッキーが存在する場合、その値（記憶トークン）を取り出す。
4.  取り出した記憶トークンをハッシュ化し、`remember_digest`カラムの値と一致するユーザーをDBから検索する。
5.  一致するユーザーが見つかった場合、そのユーザーのセッションを新規に作成し、自動的にログイン状態にする。
6.  フロントエンドはメイン画面を表示する。

### 2.4. ログアウトフロー

1.  ユーザーが「ログアウト」ボタンをクリックする。
2.  バックエンドはセッションを破棄する。
3.  同時に、DBの`remember_digest`を`NULL`で更新し、ブラウザの永続クッキーも削除する。これにより、自動ログインを無効化する。
4.  フロントエンドはトップページに遷移する。

## 3. APIエンドポイント

- `GET /api/v1/auth/google_oauth2`: Google認証を開始する。
- `GET /api/v1/auth/google_oauth2/callback`: Googleからのコールバックを処理し、ログインと（必要なら）永続化処理を行う。
- `DELETE /api/v1/auth/logout`: ログアウト処理を行う。
- `GET /api/v1/sessions/check`: 現在のログイン状態を確認するエンドポイント。

## 4. データモデル

- `users`テーブルに`remember_digest`カラムを追加。（詳細は[データベース設計書](./07_database_design.md)を参照）