# 機能仕様書: Googleカレンダー連携

- **ID**: 02
- **機能名**: 予定のインポートと表示
- **関連要件**: Googleカレンダー連携

## 1. 機能概要

ログインしているユーザーのGoogleカレンダーから予定を取得し、画面の「予定（Plan）」欄に表示する。

## 2. 仕様詳細

### 2.1. データ取得フロー

1.  ユーザーがメイン画面を表示する（または日付ナビゲーションで日付を変更する）。
2.  フロントエンドは、表示対象の日付（例: `2025-06-29`）をパラメータとして、バックエンドに予定取得APIをリクエストする。
3.  バックエンドは、リクエストされたユーザーのDBに保存されているGoogleアクセストークン（初回認証時に取得・保存したもの）を利用して、Google Calendar APIにアクセスする。
4.  APIリクエスト時には、取得する期間（`timeMin`, `timeMax`）を指定し、対象日の00:00:00から23:59:59までのイベントを取得する。
5.  Google Calendar APIから取得した予定データ（タイトル、開始時刻、終了時刻など）を、フロントエンドで扱いやすい形式に整形してレスポンスとして返す。

### 2.2. データ表示

- フロントエンドは、APIから受け取った予定データを、画面左側の「予定」グリッドにマッピングする。
- 各予定は、開始時刻と終了時刻に基づいて、時間軸上の正しい位置と高さで表示されるブロックとなる。
- ブロック内には、予定のタイトルが表示される。

### 2.3. トークンのリフレッシュ

- Googleのアクセストークンには有効期限があるため、バックエンドはAPIアクセス時にトークンの有効期限をチェックする。
- トークンが期限切れの場合、初回認証時に取得・保存しておいたリフレッシュトークンを使い、Googleから新しいアクセストークンを再取得し、DBの情報を更新してからAPIアクセスを行う。

## 3. APIエンドポイント

- `GET /api/v1/calendar/events?date=YYYY-MM-DD`: 指定された日付のGoogleカレンダーの予定を取得する。

## 4. データモデル

- 取得したカレンダーデータは永続化せず、都度APIを介して取得する。
- ユーザーのGoogleアクセストークンとリフレッシュトークンは`users`テーブルに保存する。（詳細は[データベース設計書](./07_database-design.md)を参照）

## 5. その他

- ユーザーがGoogle認証時に`calendar.readonly`スコープを許可している必要がある。
- 終日イベントは、当面は仕様の対象外とするが、将来的には画面上部に表示するなどの検討を行う。
